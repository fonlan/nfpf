# nftables端口转发管理脚本使用说明

## 概述
这是一个基于nftables的端口转发管理脚本，专为Debian系Linux发行版设计，提供了完整的端口转发规则管理功能。

## 功能特性
- ✅ 支持Debian系Linux（Ubuntu、Debian等）
- ✅ 列出所有端口转发规则
- ✅ 创建新的端口转发规则
- ✅ 删除现有端口转发规则
- ✅ 修改端口转发规则
- ✅ 通过ID指定规则进行精确操作（新增）
- ✅ 交互式和命令行两种使用方式
- ✅ 自动初始化nftables环境
- ✅ 支持TCP/UDP协议
- ✅ 支持指定网络接口
- ✅ 自动启用IP转发
- ✅ 配置持久化保存
- ✅ 支持规则注释功能，便于管理和识别

## 安装和准备

### 1. 下载脚本
```bash
# 下载脚本（假设已有）
chmod +x nfpf.sh
```

### 2. 运行权限
脚本需要root权限运行：
```bash
sudo ./nfpf.sh
```

## 使用方法

### 交互式使用（推荐新手）
直接运行脚本进入交互式菜单：
```bash
sudo ./nfpf.sh
```

### 命令行使用

#### 初始化环境（首次使用）
```bash
sudo ./nfpf.sh --init
```

#### 列出所有端口转发规则
```bash
sudo ./nfpf.sh --list
```

#### 创建端口转发规则
```bash
# 基本用法
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80

# 指定网络接口
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 eth0

# UDP端口转发
sudo ./nfpf.sh create udp 53 8.8.8.8 53

# 创建带注释的规则
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 "" "Web服务器"
sudo ./nfpf.sh create tcp 8081 192.168.1.101 80 eth0 "内部Web服务"
```

#### 删除端口转发规则
```bash
# 删除TCP规则
sudo ./nfpf.sh delete 8080 tcp

# 删除UDP规则  
sudo ./nfpf.sh delete 53 udp
```

#### 保存配置
```bash
sudo ./nfpf.sh --save
```

### 通过ID指定规则（新增功能）

#### 功能概述
通过ID指定规则功能允许用户使用唯一的ID编号来精确操作端口转发规则，解决了使用端口和协议可能存在的冲突问题。每个规则在列表中都有一个唯一的ID，可以通过ID进行修改和删除操作。

#### 为什么需要ID功能
- **解决端口冲突**：当多个规则使用相同端口但不同协议或接口时，通过端口和协议无法精确指定规则
- **精确操作**：ID提供了一种无歧义的规则识别方式，确保操作的是正确的规则
- **简化管理**：在复杂环境中，通过ID管理规则比通过端口和协议更直观

#### 通过ID列出规则
```bash
# 列出所有规则（包含ID列）
sudo ./nfpf.sh --list
```

#### 通过ID修改规则

##### 交互式修改
```bash
# 进入交互式修改模式
sudo ./nfpf.sh --modify-id
```

##### 命令行修改
```bash
# 通过ID修改规则（交互式）
sudo ./nfpf.sh --modify-id
# 然后按照提示输入规则ID和新的规则参数
```

#### 通过ID删除规则

##### 交互式删除
```bash
# 进入交互式删除模式
sudo ./nfpf.sh --delete-id
```

##### 命令行删除
```bash
# 通过ID删除规则（交互式）
sudo ./nfpf.sh --delete-id
# 然后按照提示输入要删除的规则ID
```

#### 使用示例

##### 示例1：通过ID修改规则
```bash
# 1. 首先列出所有规则，查看ID
sudo ./nfpf.sh --list
# 输出：
# ID    协议    源IP(任意)    源端口    目标IP        目标端口    接口    注释
# 1     tcp     any           8080      192.168.1.100  80          eth0    Web服务器
# 2     tcp     any           8081      192.168.1.101  80          -       测试服务器

# 2. 通过ID修改规则
sudo ./nfpf.sh --modify-id
# 按照提示输入规则ID: 1
# 然后输入新的规则参数（可以直接按回车保留原值）
```

##### 示例2：通过ID删除规则
```bash
# 1. 首先列出所有规则，查看ID
sudo ./nfpf.sh --list

# 2. 通过ID删除规则
sudo ./nfpf.sh --delete-id
# 按照提示输入规则ID: 2
# 确认删除操作
```

##### 示例3：解决端口冲突场景
```bash
# 场景：有两个TCP规则都使用8080端口，但目标IP不同
# 规则1: 8080 -> 192.168.1.100:80 (ID: 1)
# 规则2: 8080 -> 192.168.1.101:80 (ID: 2)

# 使用传统方式删除会失败或删除错误的规则
sudo ./nfpf.sh delete 8080 tcp  # 可能删除错误的规则

# 使用ID方式精确删除
sudo ./nfpf.sh --delete-id
# 输入ID: 1  # 精确删除第一个规则
```

## 使用示例

### 示例1：Web服务端口转发
将外部8080端口转发到内网服务器的80端口：
```bash
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80
```

### 示例2：SSH端口转发
将外部2222端口转发到内网服务器的22端口：
```bash
sudo ./nfpf.sh create tcp 2222 192.168.1.50 22
```

### 示例3：DNS服务转发
将UDP 53端口转发到公共DNS服务器：
```bash
sudo ./nfpf.sh create udp 53 8.8.8.8 53
```

### 示例4：游戏服务器端口转发
转发游戏服务器端口（通常需要TCP和UDP）：
```bash
sudo ./nfpf.sh create tcp 25565 192.168.1.200 25565
sudo ./nfpf.sh create udp 25565 192.168.1.200 25565
```

### 示例5：创建带注释的规则
创建带有描述性注释的规则，便于管理：
```bash
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 "" "公司Web服务器"
sudo ./nfpf.sh create tcp 3306 192.168.1.200 3306 "" "数据库服务器"
sudo ./nfpf.sh create tcp 2222 192.168.1.50 22 eth0 "SSH管理端口"
```

## 交互式菜单选项说明

1. **列出端口转发规则** - 显示当前所有活动的端口转发规则（包含ID列）
2. **创建端口转发规则** - 通过向导创建新的端口转发规则
3. **删除端口转发规则** - 通过端口和协议删除指定的端口转发规则
4. **修改端口转发规则** - 通过端口和协议修改现有的端口转发规则
5. **通过ID删除规则** - 通过唯一ID精确删除指定的端口转发规则
6. **通过ID修改规则** - 通过唯一ID精确修改现有的端口转发规则
7. **保存配置** - 将当前规则保存到配置文件
8. **初始化nftables** - 设置nftables环境（首次使用）

## 命令行参数

| 参数 | 短参数 | 功能 |
|------|--------|------|
| --list | -l | 列出所有端口转发规则 |
| --create | -c | 交互式创建端口转发规则 |
| --delete | -d | 交互式删除端口转发规则 |
| --modify | -m | 交互式修改端口转发规则 |
| --modify-id | - | 通过ID交互式修改端口转发规则 |
| --delete-id | - | 通过ID交互式删除端口转发规则 |
| --save | -s | 保存当前规则到配置文件 |
| --init | -i | 初始化nftables环境 |
| --help | -h | 显示帮助信息 |

### 非交互式命令格式

#### 创建规则
```bash
sudo ./nfpf.sh create <protocol> <src_port> <dst_ip> <dst_port> [interface] [comment]
```

#### 删除规则
```bash
sudo ./nfpf.sh delete <src_port> [protocol]
```

#### 通过ID修改规则
```bash
sudo ./nfpf.sh --modify-id
```

#### 通过ID删除规则
```bash
sudo ./nfpf.sh --delete-id
```

#### 参数说明
- `protocol`: 协议类型 (tcp/udp)
- `src_port`: 源端口号 (1-65535)
- `dst_ip`: 目标IP地址
- `dst_port`: 目标端口号 (1-65535)
- `interface`: 可选，网络接口名称
- `comment`: 可选，规则注释 (最多128字符)

## 注释功能详解

### 功能概述
注释功能允许为端口转发规则添加描述性文本，便于管理和识别规则用途。注释会保存在nftables规则中，并在规则列表中显示。

### 注释规则和限制
- 注释长度限制为128个字符
- 不支持换行符
- 支持中文、英文和特殊字符
- 特殊字符会自动转义处理

### 使用方法

#### 1. 创建带注释的规则
```bash
# 基本格式
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 "" "Web服务器"

# 指定接口和注释
sudo ./nfpf.sh create tcp 8081 192.168.1.101 80 eth0 "内部Web服务"
```

#### 2. 修改规则注释
通过交互式修改功能可以更新规则注释：
```bash
sudo ./nfpf.sh --modify
# 选择要修改的规则，然后输入新的注释
```

#### 3. 查看规则注释
使用列表命令查看所有规则及其注释：
```bash
sudo ./nfpf.sh --list
```

### 交互式界面中的注释功能

#### 创建规则时的注释输入
在交互式创建规则过程中，系统会提示输入注释：
```
请输入规则注释（回车跳过）: Web服务器
```

#### 修改规则时的注释更新
在交互式修改规则过程中，可以更新注释：
```
注释 [默认: Web服务器]: 内部Web服务器
```

### 注释显示格式
- 在规则列表中，注释会显示在最后一列
- 注释长度超过20字符时会自动截断显示
- 完整注释保存在规则中，不受显示限制影响

## 注意事项

1. **权限要求**：脚本必须以root权限运行
2. **系统兼容性**：仅支持Debian系Linux发行版
3. **防火墙**：确保系统防火墙允许相关端口通信
4. **网络接口**：可以指定特定网络接口，或应用到所有接口
5. **持久化**：使用--save保存配置，确保重启后规则仍然有效
6. **备份**：修改重要规则前建议备份当前配置
7. **注释兼容性**：注释功能需要nftables支持comment关键字
8. **向后兼容性**：不带注释的规则与旧版本完全兼容
9. **ID使用注意**：ID在每次列表显示时重新分配，请以最新列表显示的ID为准
10. **ID精确性**：通过ID操作规则更加精确，特别是在存在端口冲突的情况下
11. **ID映射关系**：ID与规则之间的映射关系是动态的，删除规则后ID会重新分配

## 故障排除

### nftables服务未运行
```bash
sudo systemctl enable nftables
sudo systemctl start nftables
```

### IP转发未启用
脚本会自动启用，或手动执行：
```bash
echo 'net.ipv4.ip_forward=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 查看详细的nftables规则
```bash
sudo nft list ruleset
```

### 清空所有规则（谨慎使用）
```bash
sudo nft flush ruleset
```

## 配置文件位置
- nftables配置：`/etc/nftables.conf`
- 系统网络配置：`/etc/sysctl.conf`

## 注释功能高级用法

### 常见注释示例

#### 服务标识
```bash
sudo ./nfpf.sh create tcp 80 192.168.1.100 80 "" "主Web服务器"
sudo ./nfpf.sh create tcp 443 192.168.1.100 443 "" "HTTPS服务"
sudo ./nfpf.sh create tcp 3306 192.168.1.200 3306 "" "MySQL数据库"
```

#### 环境区分
```bash
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 "" "测试环境-Web"
sudo ./nfpf.sh create tcp 8081 192.168.1.101 80 "" "开发环境-Web"
sudo ./nfpf.sh create tcp 8082 192.168.1.102 80 "" "生产环境-Web"
```

#### 部门或项目标识
```bash
sudo ./nfpf.sh create tcp 9000 192.168.1.150 9000 "" "技术部-监控系统"
sudo ./nfpf.sh create tcp 9001 192.168.1.151 9000 "" "市场部-CRM系统"
sudo ./nfpf.sh create tcp 9002 192.168.1.152 9000 "" "财务部-ERP系统"
```

#### 临时规则标记
```bash
sudo ./nfpf.sh create tcp 9999 192.168.1.100 3389 "" "临时-远程桌面(2024-01-15到期)"
sudo ./nfpf.sh create tcp 8888 192.168.1.101 22 "" "临时-SSH维护(今日)"
```

### 注释管理最佳实践

1. **保持简洁明了**：使用简短但描述性的注释
2. **包含关键信息**：服务名称、环境、负责人等
3. **定期更新**：及时更新过时的注释信息
4. **统一格式**：团队内使用统一的注释格式
5. **避免特殊字符**：尽量使用标准字符，避免转义问题

### 注释功能故障排除

#### 注释显示异常
如果注释显示不正确，可能是以下原因：
- nftables版本不支持comment关键字
- 注释中包含未正确转义的特殊字符
- 注释长度超过128字符限制

#### 注释保存问题
如果注释无法保存，请检查：
- 是否有足够的系统权限
- nftables服务是否正常运行
- 配置文件是否可写

## ID功能详解

### 功能概述
ID功能为每个端口转发规则分配一个唯一的数字标识符，使用户能够精确地指定和操作规则。这个功能特别适用于复杂网络环境，特别是在存在端口冲突的情况下。

### ID的生成方式和特点
- **动态分配**：ID在每次列出规则时重新分配，从1开始连续编号
- **唯一性**：在单次列表显示中，每个规则都有唯一的ID
- **临时性**：ID不是永久性的，会随着规则的增删而变化
- **一致性**：在同一次操作过程中，ID保持不变

### ID与规则之间的映射关系
- ID与规则之间通过协议和源端口建立映射关系
- 系统内部使用关联数组存储ID到规则的映射
- 每次操作前都会重新构建ID映射，确保准确性
- 相同协议和源端口的规则会被分配相同的ID

### 使用ID功能的最佳实践

#### 1. 操作前先列出规则
```bash
# 始终先列出规则，获取最新的ID
sudo ./nfpf.sh --list
```

#### 2. 在复杂环境中优先使用ID
当存在以下情况时，建议使用ID功能：
- 多个规则使用相同端口但不同协议
- 多个规则使用相同端口和协议但不同目标
- 需要精确操作特定规则时

#### 3. 避免长时间保存ID
不要长时间保存ID值，因为它们可能会变化：
```bash
# 不好的做法：保存ID供后续使用
RULE_ID=3
# ...一段时间后...
sudo ./nfpf.sh --modify-id  # 输入之前保存的ID，可能不准确

# 好的做法：每次操作前重新获取ID
sudo ./nfpf.sh --list
sudo ./nfpf.sh --modify-id  # 输入刚刚获取的ID
```

#### 4. 结合注释功能使用
将ID功能与注释功能结合使用，可以更好地管理规则：
```bash
# 创建带注释的规则
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80 "" "主Web服务器"

# 通过ID和注释识别规则
sudo ./nfpf.sh --list
# ID    协议    源IP(任意)    源端口    目标IP        目标端口    接口    注释
# 1     tcp     any           8080      192.168.1.100  80          -       主Web服务器
```

### ID功能与原有功能的对比

| 特性 | 原有功能（端口+协议） | ID功能 |
|------|---------------------|--------|
| 精确性 | 可能存在冲突 | 完全精确 |
| 易用性 | 简单直观 | 需要先查看ID |
| 适用场景 | 简单环境 | 复杂环境 |
| 冲突处理 | 无法处理冲突 | 完美解决冲突 |
| 学习成本 | 低 | 略高 |

### ID功能的高级用法

#### 1. 批量操作
虽然ID功能主要用于单个规则操作，但可以结合脚本实现批量操作：
```bash
# 批量删除前3个规则（谨慎使用）
for id in 1 2 3; do
    echo "$id" | sudo ./nfpf.sh --delete-id <<< "y"
done
```

#### 2. 规则备份和恢复
```bash
# 备份规则列表（包含ID）
sudo ./nfpf.sh --list > rules_backup.txt

# 查看备份的规则
cat rules_backup.txt
```

#### 3. 规则检查和验证
```bash
# 定期检查规则状态
sudo ./nfpf.sh --list | grep "8080"
```

## 向后兼容性

### 原有功能保持不变
- 所有原有的命令行选项和参数继续可用
- 原有的交互式菜单选项保持不变
- 原有的脚本使用方式完全兼容

### 新旧功能使用建议

#### 1. 简单环境
在规则数量少、无端口冲突的简单环境中，可以继续使用原有功能：
```bash
# 创建规则
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80

# 删除规则
sudo ./nfpf.sh delete 8080 tcp
```

#### 2. 复杂环境
在规则数量多、可能存在端口冲突的复杂环境中，建议使用ID功能：
```bash
# 列出规则
sudo ./nfpf.sh --list

# 通过ID修改规则
sudo ./nfpf.sh --modify-id

# 通过ID删除规则
sudo ./nfpf.sh --delete-id
```

#### 3. 混合使用
可以根据具体场景灵活选择使用方式：
```bash
# 创建规则（使用原有方式）
sudo ./nfpf.sh create tcp 8080 192.168.1.100 80

# 修改规则（使用ID方式，更精确）
sudo ./nfpf.sh --modify-id

# 删除规则（根据情况选择）
sudo ./nfpf.sh delete 8080 tcp  # 如果确定无冲突
# 或
sudo ./nfpf.sh --delete-id     # 如果存在冲突或需要精确操作
```

## 技术细节
- 使用nftables的nat表进行端口转发
- 自动创建SNAT规则确保回包正确路由
- 支持句柄(handle)方式精确删除规则
- 彩色输出提升用户体验
- 注释功能使用nftables的comment关键字实现
- 自动转义注释中的特殊字符，确保规则正确执行
- ID功能使用关联数组实现ID到规则的映射
- 每次操作前重新构建ID映射，确保准确性