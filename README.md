# nftables端口转发管理脚本使用说明

## 概述
这是一个基于nftables的端口转发管理脚本，专为Debian系Linux发行版设计，提供了完整的端口转发规则管理功能。

## 功能特性
- ✅ 支持Debian系Linux（Ubuntu、Debian等）
- ✅ 列出所有端口转发规则
- ✅ 创建新的端口转发规则
- ✅ 删除现有端口转发规则
- ✅ 修改端口转发规则
- ✅ 通过ID指定规则进行精确操作（在交互式菜单中）
- ✅ 交互式菜单操作方式
- ✅ 自动初始化nftables环境
- ✅ 支持TCP/UDP协议
- ✅ 支持指定网络接口
- ✅ 自动启用IP转发
- ✅ 配置持久化保存
- ✅ 支持规则注释功能，便于管理和识别

## 安装和准备

### 1. 下载脚本
```bash
# 下载脚本（假设已有）
chmod +x nfpf.sh
```

### 2. 运行权限
脚本需要root权限运行：
```bash
sudo ./nfpf.sh
```

## 使用方法

### 交互式使用
脚本主要通过交互式菜单操作，直接运行脚本进入主菜单：
```bash
sudo ./nfpf.sh
```

### 命令行参数
脚本目前只支持以下命令行参数：
```bash
# 显示帮助信息
sudo ./nfpf.sh -h
sudo ./nfpf.sh --help
```

### 通过ID指定规则（在交互式菜单中）

脚本支持通过ID精确操作端口转发规则。每个规则在列表中都有一个唯一的ID，可以通过ID进行修改和删除操作，特别适用于存在端口冲突的情况。

使用方法：
1. 在交互式菜单中选择"列出端口转发规则"查看规则ID
2. 在修改或删除规则时，输入对应的规则ID进行操作

## 使用示例

### 示例1：Web服务端口转发
将外部8080端口转发到内网服务器的80端口：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"2) 创建端口转发规则"
# 按照提示输入：
# 协议: tcp
# 源端口: 8080
# 目标IP: 192.168.1.100
# 目标端口: 80
# 网络接口: （回车跳过，应用到所有接口）
# 注释: Web服务器
```

### 示例2：SSH端口转发
将外部2222端口转发到内网服务器的22端口：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"2) 创建端口转发规则"
# 按照提示输入：
# 协议: tcp
# 源端口: 2222
# 目标IP: 192.168.1.50
# 目标端口: 22
# 网络接口: （回车跳过，应用到所有接口）
# 注释: SSH管理端口
```

### 示例3：DNS服务转发
将UDP 53端口转发到公共DNS服务器：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"2) 创建端口转发规则"
# 按照提示输入：
# 协议: udp
# 源端口: 53
# 目标IP: 8.8.8.8
# 目标端口: 53
# 网络接口: （回车跳过，应用到所有接口）
# 注释: DNS转发
```

### 示例4：游戏服务器端口转发
转发游戏服务器端口（通常需要TCP和UDP）：
```bash
# 创建TCP规则
sudo ./nfpf.sh
# 选择"2) 创建端口转发规则"
# 按照提示输入TCP规则信息

# 创建UDP规则
sudo ./nfpf.sh
# 选择"2) 创建端口转发规则"
# 按照提示输入UDP规则信息
```

### 示例5：创建带注释的规则
创建带有描述性注释的规则，便于管理：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"2) 创建端口转发规则"
# 按照提示输入规则信息，并在注释字段输入描述性文本
```

## 交互式菜单选项说明

1. **列出端口转发规则** - 显示当前所有活动的端口转发规则（包含ID列）
2. **创建端口转发规则** - 通过向导创建新的端口转发规则
3. **删除端口转发规则** - 通过源端口和协议删除指定的端口转发规则
4. **修改端口转发规则** - 通过ID精确修改现有的端口转发规则
5. **退出** - 退出程序

## 命令行参数

| 参数 | 短参数 | 功能 |
|------|--------|------|
| --help | -h | 显示帮助信息 |

注意：脚本主要通过交互式菜单操作，不支持非交互式命令格式。

## 注释功能详解

### 功能概述
注释功能允许为端口转发规则添加描述性文本，便于管理和识别规则用途。注释会保存在nftables规则中，并在规则列表中显示。

### 注释规则和限制
- 注释长度限制为128个字符
- 不支持换行符
- 支持中文、英文和特殊字符
- 特殊字符会自动转义处理

### 使用方法

#### 1. 创建带注释的规则
在交互式创建规则过程中，系统会提示输入注释：
```
请输入规则注释（回车跳过）: Web服务器
```

#### 2. 修改规则注释
通过交互式修改功能可以更新规则注释：
```
注释 [默认: Web服务器]: 内部Web服务器
```

#### 3. 查看规则注释
在交互式菜单中选择"列出端口转发规则"选项，查看所有规则及其注释。

### 注释显示格式
- 在规则列表中，注释会显示在最后一列
- 注释长度超过20字符时会自动截断显示
- 完整注释保存在规则中，不受显示限制影响

## 注意事项

1. **权限要求**：脚本必须以root权限运行
2. **系统兼容性**：仅支持Debian系Linux发行版
3. **防火墙**：确保系统防火墙允许相关端口通信
4. **网络接口**：可以指定特定网络接口，或应用到所有接口
5. **持久化**：脚本会自动保存配置，确保重启后规则仍然有效
6. **备份**：修改重要规则前建议备份当前配置
7. **注释兼容性**：注释功能需要nftables支持comment关键字
8. **ID使用注意**：ID在每次列表显示时重新分配，请以最新列表显示的ID为准
9. **交互式操作**：脚本主要通过交互式菜单操作，不支持非交互式命令格式

## 故障排除

### nftables服务未运行
```bash
sudo systemctl enable nftables
sudo systemctl start nftables
```

### IP转发未启用
脚本会自动启用，或手动执行：
```bash
echo 'net.ipv4.ip_forward=1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 查看详细的nftables规则
```bash
sudo nft list ruleset
```

### 清空所有规则（谨慎使用）
```bash
sudo nft flush ruleset
```

## 配置文件位置
- nftables配置：`/etc/nftables.conf`
- 系统网络配置：`/etc/sysctl.conf`

## 注释功能高级用法

### 常见注释示例

#### 服务标识
在交互式创建规则时，在注释字段输入：
- "主Web服务器"
- "HTTPS服务"
- "MySQL数据库"

#### 环境区分
在交互式创建规则时，在注释字段输入：
- "测试环境-Web"
- "开发环境-Web"
- "生产环境-Web"

#### 部门或项目标识
在交互式创建规则时，在注释字段输入：
- "技术部-监控系统"
- "市场部-CRM系统"
- "财务部-ERP系统"

#### 临时规则标记
在交互式创建规则时，在注释字段输入：
- "临时-远程桌面(2024-01-15到期)"
- "临时-SSH维护(今日)"

### 注释管理最佳实践

1. **保持简洁明了**：使用简短但描述性的注释
2. **包含关键信息**：服务名称、环境、负责人等
3. **定期更新**：及时更新过时的注释信息
4. **统一格式**：团队内使用统一的注释格式
5. **避免特殊字符**：尽量使用标准字符，避免转义问题

### 注释功能故障排除

#### 注释显示异常
如果注释显示不正确，可能是以下原因：
- nftables版本不支持comment关键字
- 注释中包含未正确转义的特殊字符
- 注释长度超过128字符限制

#### 注释保存问题
如果注释无法保存，请检查：
- 是否有足够的系统权限
- nftables服务是否正常运行
- 配置文件是否可写

## 使用建议

### 1. 简单环境
在规则数量少、无端口冲突的简单环境中，可以使用源端口和协议方式删除规则：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"3) 删除端口转发规则"
# 输入源端口和协议
```

### 2. 复杂环境
在规则数量多、可能存在端口冲突的复杂环境中，建议使用ID功能：
```bash
# 运行脚本进入交互式菜单
sudo ./nfpf.sh

# 选择"1) 列出端口转发规则"查看ID

# 选择"4) 修改端口转发规则"或"3) 删除端口转发规则"
# 输入规则ID进行精确操作
```

## 技术细节
- 使用nftables的nat表进行端口转发
- 自动创建SNAT规则确保回包正确路由
- 支持句柄(handle)方式精确删除规则
- 彩色输出提升用户体验
- 注释功能使用nftables的comment关键字实现
- 自动转义注释中的特殊字符，确保规则正确执行
- 自动初始化nftables环境
- 自动启用IP转发
- 配置持久化保存